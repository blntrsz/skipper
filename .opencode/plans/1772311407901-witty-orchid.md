# Plan: aws bootstrap infra refactor

## Locked decisions
- command name: `aws bootstrap`
- infra scope: API Gateway REST + EventBridge only
- no Lambda in bootstrap stack
- EventBridge bus: create custom bus in stack
- keep optional GitHub webhook upsert in bootstrap
- `aws run` + `workers sync`: deprecate, fail-fast on bootstrap-only stack

## Files to change
- `src/command/aws/index.ts`
- `src/command/aws/bootstrap.ts` (new; replaces deploy command impl)
- `src/command/aws/defaults.ts` (new shared defaults/parsers)
- `src/command/aws/template.ts`
- `src/command/aws/deploy.ts` (remove or convert to thin migration stub if needed)
- `src/command/aws/run.ts`
- `src/command/workers/sync.ts`
- `src/command/aws/bootstrap.test.ts` (new/renamed from deploy test)
- `src/command/aws/template.test.ts`
- `src/command/aws/run.test.ts` (if adding fail-fast helper test)
- `src/command/workers/sync.test.ts` (if adding guard helper test)
- `package.json`
- optional cleanup if unused: `scripts/generate-lambda-artifact.ts`, `src/command/aws/lambda-source.ts`, `src/command/aws/lambda-artifact.generated.ts`

## Implementation steps
1. Rename command + isolate shared defaults
- Create `registerAwsBootstrapCommand()` in `src/command/aws/bootstrap.ts`.
- Register `.command("bootstrap")` with deploy-like args/options.
- Keep options needed for bootstrap: `--region`, `--profile`, `--stack-name`, `--api-name`, `--stage-name`, `--timeout-minutes`, `--tags`, `--github-repo`, `--github-events`, `--github-secret`, `--skip-github-webhook`, `--dry-run-template`.
- Add EventBridge options: `--event-bus-name`, `--event-source`, `--event-detail-type`.
- Move `resolveDeployDefaults`, name validation, tag parsing, event parsing into new `src/command/aws/defaults.ts` so `aws run` and `workers sync` stop importing from `deploy.ts`.
- Update `src/command/aws/index.ts` to register bootstrap command.

2. Remove Lambda artifact path from bootstrap flow
- In new bootstrap handler, delete STS/EC2/S3 artifact prep path and Lambda artifact fields.
- `createTemplateParameters` should only pass API/EventBridge + webhook-related params.
- Dry-run JSON should include EventBridge config, not `lambdaArtifactSha256`.
- Keep CloudFormation deploy path (`deployStack`) and output printing.

3. Rewrite CloudFormation template to pattern
- Refactor `src/command/aws/template.ts` to represent API Gateway REST -> EventBridge direct integration pattern.
- Keep resources:
  - `AWS::Events::EventBus`
  - IAM role assumed by API Gateway with `events:PutEvents` on bus ARN
  - `AWS::ApiGateway::RestApi`, `/events` resource, `POST` method, deployment, stage
- Integration details:
  - URI: `arn:${AWS::Partition}:apigateway:${AWS::Region}:events:action/PutEvents`
  - Set headers via VTL override: `X-Amz-Target=AWSEvents.PutEvents`, `Content-Type=application/x-amz-json-1.1`
  - Map request body to `Entries` for PutEvents, include source/detailType/eventBusName, pass payload + selected headers/context in detail.
- Remove SQS/ECS/Lambda resources, worker params, Lambda params/outputs.
- Outputs should include `ApiInvokeUrl`, `ApiId`, `ApiStageName`, `EventBusName`, `EventBusArn`.

4. Keep GitHub webhook optional
- Preserve webhook upsert flow in bootstrap when not `--skip-github-webhook`.
- Continue using `ApiInvokeUrl` output as webhook URL.
- Keep `--github-secret` generation/rotation behavior.

5. Deprecate legacy commands with explicit fail-fast
- `src/command/aws/run.ts`: add deprecation note + explicit error text if stack lacks ECS outputs (indicate bootstrap-only stack; run moved to separate stack).
- `src/command/workers/sync.ts`: guard before update; if worker params not present in stack/template contract, fail with migration message (no silent bad update).

6. Clean build pipeline of Lambda artifact generation
- If bootstrap no longer references lambda artifact source, remove `build:lambda-artifact` from `package.json` build chain.
- Remove lambda artifact generation files only if truly unreferenced after refactor.

7. Tests
- Replace `src/command/aws/deploy.test.ts` with `src/command/aws/bootstrap.test.ts` covering:
  - defaults/parsers still valid
  - bootstrap template parameter map (EventBridge params)
  - dry-run payload excludes lambda artifact field
- Rewrite `src/command/aws/template.test.ts` assertions to EventBridge pattern resources; assert old resources absent.
- Add/adjust tests for new fail-fast/deprecation helper paths in `src/command/aws/run.ts` and `src/command/workers/sync.ts`.

## Verification
1. Local tests/build
- `bun test`
- `bun run typecheck`
- `bun run build`

2. CLI dry-run sanity
- `bun run cli -- aws bootstrap my-service sandbox --dry-run-template`
- verify dry-run template has EventBridge/API resources, no Lambda/SQS/ECS resources.

3. Cloud deploy sanity (real AWS, optional in CI)
- `bun run cli -- aws bootstrap my-service sandbox --region <region> --profile <profile>`
- confirm outputs include `ApiInvokeUrl` + `EventBusArn`.

4. Endpoint behavior
- POST sample payload to `${ApiInvokeUrl}`.
- verify API returns success mapping and EventBridge receives event on created bus.

## Unresolved questions
- none
