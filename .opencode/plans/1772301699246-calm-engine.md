# Workers framework + AWS sync

## Goal
Add repo-defined workers (`.skipper/worker/*.ts`), starting with `review`, and add CLI command to sync worker config into AWS stack config. Keep current webhook -> SQS -> Lambda -> ECS flow. Support many workers, not review-only.

## Confirmed decisions
- Worker dir: `.skipper/worker` (singular)
- Worker config format: TS module exports
- Sync target: CloudFormation params/env
- PR review default: comment-only (no push)

## Implementation plan

1) Add worker contract + loader (repo side)
- Add `src/worker/contract.ts`
  - Types: worker metadata, trigger rules, runtime config.
  - Runtime validator for plain-JSON export shape (no functions).
- Add `src/worker/load.ts`
  - Discover `.skipper/worker/*.ts` from repo root.
  - Load modules, validate, normalize, dedupe ids.
- Add `src/worker/serialize.ts`
  - Serialize manifest JSON.
  - Compress + base64 encode.
  - Chunk for CFN params (safe per-param size).
  - Add checksum/version helpers.

2) Add event router (runtime side)
- Add `src/worker/route.ts`
  - Pure matcher: GitHub event + action + optional repo/branch filters -> matched workers.
  - Skip disabled workers.

3) Add workers CLI namespace + sync command
- Add `src/command/workers/index.ts`
  - Register `workers` namespace.
- Add `src/command/workers/sync.ts`
  - Command: `skipper workers sync [service] [env]`
  - Options: `--stack-name`, `--region`, `--profile`, `--dir`, `--dry-run`, `--strict`, `--timeout-minutes`.
  - Flow:
    - Resolve defaults via existing deploy defaults pattern.
    - Load + validate workers.
    - Serialize/chunk manifest.
    - Build full CFN parameter map by merging stack-required params with updated worker params.
    - Reuse existing CFN deploy helper (`deployStack`) with current template (`buildTemplate`) to avoid drift.
  - Dry-run prints worker summary + payload size/chunks + target stack.

4) Wire command registration
- Update `src/app/register-commands.ts`
  - Register `registerWorkersCommand`.

5) Extend AWS template to hold worker manifest
- Update `src/command/aws/template.ts`
  - Add CFN Parameters for worker payload:
    - `WorkersEncoding`, `WorkersSha256`, `WorkersSchemaVersion`, `WorkersChunkCount`, and chunk params (fixed count).
  - Add Lambda env vars for lightweight routing metadata (encoding/schema/hash/chunk-count).
  - Keep ECS task command mostly unchanged; worker-specific behavior flows through env overrides from Lambda.

6) Extend deploy defaults/params for worker fields
- Update `src/command/aws/deploy.ts`
  - Add worker params to `createTemplateParameters` with empty defaults so `aws deploy` remains valid pre-sync.
  - Optional: add `--sync-workers` hook to run same sync logic post-deploy.

7) Add Lambda worker routing and ECS env overrides
- Update `src/command/aws/lambda/types.ts`
  - Add typed fields needed for routing (`repository.full_name`, `pull_request.base.ref`, `pull_request.head.ref`, etc. optional).
- Update `src/command/aws/lambda/handler.ts`
  - After webhook verify + payload parse:
    - Read worker manifest from stack params (decode chunks).
    - Route matching workers by event/action.
    - For each match, run ECS task with worker env:
      - `SKIPPER_WORKER_ID`, `SKIPPER_WORKER_TYPE`, `SKIPPER_WORKER_MODE`, `SKIPPER_ALLOW_PUSH`, `PROMPT`.
  - For `review` default set `comment-only` and `allowPush=false`.
  - Keep fallback behavior when no worker matches configurable (initially: no-op + log).

8) Add first worker module
- Add `.skipper/worker/review.ts`
  - Exports metadata + trigger (`pull_request` + `opened`) + runtime config.
  - Runtime default: comment-only; no push.

9) Tests
- Add `src/worker/serialize.test.ts`
  - Roundtrip encode/decode, chunk boundaries, checksum mismatch.
- Add `src/worker/route.test.ts`
  - Event/action matching, filters, disabled workers.
- Add `src/command/workers/sync.test.ts`
  - Worker load/validate, param map generation, dry-run output model.
- Update `src/command/aws/template.test.ts`
  - Assert new worker CFN params + lambda env vars exist.
- Update `src/command/aws/deploy.test.ts`
  - Assert worker param defaults and parsing helpers.

## Critical files to modify
- `.skipper/worker/review.ts` (new)
- `src/worker/contract.ts` (new)
- `src/worker/load.ts` (new)
- `src/worker/serialize.ts` (new)
- `src/worker/route.ts` (new)
- `src/command/workers/index.ts` (new)
- `src/command/workers/sync.ts` (new)
- `src/app/register-commands.ts`
- `src/command/aws/template.ts`
- `src/command/aws/deploy.ts`
- `src/command/aws/lambda/types.ts`
- `src/command/aws/lambda/handler.ts`
- `src/worker/serialize.test.ts` (new)
- `src/worker/route.test.ts` (new)
- `src/command/workers/sync.test.ts` (new)
- `src/command/aws/template.test.ts`
- `src/command/aws/deploy.test.ts`

## Verification
1. Unit tests
- `bun test src/worker/serialize.test.ts src/worker/route.test.ts src/command/workers/sync.test.ts`
- `bun test src/command/aws/template.test.ts src/command/aws/deploy.test.ts`

2. Full test + standards
- `bun test`
- `bun run check:source-standards`

3. CLI checks
- `bun run cli -- workers sync --help`
- `bun run cli -- workers sync <service> <env> --dry-run`
- `bun run cli -- aws deploy <service> <env> --dry-run-template`

4. AWS end-to-end smoke
- Run sync against real stack.
- Send sample `pull_request` `opened` payload to API endpoint.
- Confirm Lambda logs show worker match `review`.
- Confirm ECS task env contains comment-only worker flags.

## Risks + mitigations
- CFN param size limits -> gzip+base64+chunking + hard size checks.
- Stack param overwrite risk -> preserve non-worker params during sync.
- Lambda env 4KB cap -> keep full manifest in CFN params, not env.
- Handler complexity drift -> keep routing in pure helper module + tests.
- Source standards failures -> JSDoc on each new function in `src/**/*.ts`.

## Unresolved questions
- none
