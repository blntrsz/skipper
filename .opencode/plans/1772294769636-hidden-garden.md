# Plan: `aws run` ECS Claude (Bedrock)

## Goal
Add `skipper aws run <prompt...>` that launches one ECS Fargate task from deployed stack resources, then runs Claude Code in Bedrock mode inside that task.

## Locked decisions (from user)
- Input is Claude prompt text (`claude -p` style), not raw shell command.
- Resolve ECS resources from stack (`service`/`env`), not explicit required ECS IDs.
- Bedrock auth is IAM task role only.

## Files to change
- `src/command/aws/index.ts`
- `src/command/aws/run.ts` (new)
- `src/command/aws/template.ts`
- `src/command/aws/run.test.ts` (new)
- `src/command/aws/template.test.ts`

## Implementation
1. Add new AWS subcommand wiring.
   - In `src/command/aws/index.ts`, register `registerAwsRunCommand(aws)` next to deploy.

2. Implement `aws run` command in `src/command/aws/run.ts`.
   - Commander UX:
     - `aws run [service] [env] <prompt...>`
     - options: `--region`, `--profile`, `--stack-name`, `--github-repo`, `--model`, `--wait`, `--timeout-minutes`, `--dry-run`.
   - Defaults:
     - service/env/region from `resolveDeployDefaults()`.
     - stack name default `${service}-${env}`.
     - repo default via `resolveGithubRepo()`; normalize to clone URL `https://github.com/<owner>/<repo>.git`.
   - AWS lookups:
     - `DescribeStacks` on resolved stack.
     - Read required outputs: `EcsClusterArn`, `EcsTaskDefinitionArn`, `EcsSecurityGroupId`, `EcsSubnetIdsCsv`.
   - Build ECS `RunTaskCommand` payload:
     - `launchType: FARGATE`, `assignPublicIp: ENABLED`.
     - container override name `webhook`.
     - env overrides: `PROMPT`, `REPOSITORY_URL`, `CLAUDE_CODE_USE_BEDROCK=1`, `AWS_REGION`, `AWS_DEFAULT_REGION`, optional model env var.
   - Behavior:
     - fail fast on missing stack/outputs/repo/prompt.
     - `--dry-run` prints resolved request JSON only.
     - real run prints task ARN(s); with `--wait` poll task status until STOPPED (timeout bounded).

3. Update template for Bedrock task-role access + run discovery outputs.
   - In `src/command/aws/template.ts`, add inline policy on `WebhookTaskRole` with:
     - `bedrock:InvokeModel`
     - `bedrock:InvokeModelWithResponseStream`
     - resource scope initially `*` (simple, works across model IDs/regions).
   - Add outputs:
     - `EcsSecurityGroupId` -> `Ref WebhookTaskSecurityGroup`
     - `EcsSubnetIdsCsv` -> `Fn::Join` of `SubnetIds`

4. Tests.
   - New `src/command/aws/run.test.ts` for pure helpers:
     - option/default resolution.
     - required output extraction + errors.
     - repo normalization to clone URL.
     - ECS payload build contains Bedrock env + network values.
   - Update `src/command/aws/template.test.ts`:
     - assert Bedrock IAM actions present.
     - assert new outputs exist.

## Verification
- Static checks:
  - `bun test src/command/aws/run.test.ts src/command/aws/template.test.ts`
  - `bun run typecheck`
- CLI behavior (local):
  - `bun run cli -- aws run my-service sandbox "test prompt" --dry-run`
  - confirm printed payload has stack-derived cluster/task/network + Bedrock env vars.
- AWS end-to-end (real account):
  - `bun run cli -- aws deploy my-service sandbox --region <region>` (applies task-role Bedrock policy/outputs).
  - `bun run cli -- aws run my-service sandbox "implement X" --region <region> --wait`
  - verify task reached STOPPED and inspect ECS/CloudWatch logs for Claude run output.

## Unresolved questions
- none
