# Plan: `aws deploy` webhook -> ECS tasks

## Goal
`aws deploy` must deploy: API Gateway -> SQS -> Lambda -> ECS RunTask. Lambda source must be typed TS using `@octokit/webhooks`, not raw string, still embedded in single CLI binary.

## Locked decisions
- One ECS task model for all webhook events
- ECS task image fixed in template: `public.ecr.aws/docker/library/busybox:latest` (placeholder)
- Networking: default VPC discovery
- Lambda behavior: ECS only (remove HTTP forward)
- Webhook signature verify required
- Webhook secret: auto-generate each deploy

## Files to modify
- `src/command/aws/deploy.ts`
- `src/command/aws/template.ts`
- `src/command/aws/cloudformation.ts` (if param handling tweak needed)
- `src/command/aws/github.ts`
- `src/command/aws/lambda-source.ts` (replace with typed-file embed entry)
- `src/command/aws/lambda/handler.ts` (new)
- `src/command/aws/lambda/types.ts` (new)
- `src/command/aws/network.ts` (new)
- `src/command/aws/lambda-artifact.generated.ts` (new, generated)
- `scripts/generate-lambda-artifact.ts` (new)
- `package.json`
- `src/command/aws/*.test.ts` (+ new lambda/network tests)

## Implementation
1. Typed Lambda source + webhook verify
- Create `src/command/aws/lambda/handler.ts` with full TS types.
- Parse SQS message payload containing `rawBodyB64`, `x-hub-signature-256`, `x-github-event`, `x-github-delivery`.
- Verify signature via `@octokit/webhooks` (`Webhooks.verify`), reject invalid.
- Parse payload JSON only after verify.
- Run ECS task using `@aws-sdk/client-ecs` `RunTask`.
- Pass metadata only to container env overrides (`GITHUB_EVENT`, `GITHUB_DELIVERY`, `GITHUB_REPO`, `GITHUB_ACTION`).

2. Embed lambda artifact in binary (no runtime source file reads)
- Add `scripts/generate-lambda-artifact.ts`:
  - bundle `src/command/aws/lambda/handler.ts` with Bun,
  - zip bundled JS,
  - emit `src/command/aws/lambda-artifact.generated.ts` exporting base64 zip + sha256.
- Update `src/command/aws/lambda-source.ts` to import/export generated artifact metadata (no raw handler string).
- Update `package.json` scripts:
  - `build:lambda-artifact`
  - make `build` run artifact generation before `bun build --compile`.

3. Deploy flow updates
- In `src/command/aws/deploy.ts`:
  - remove destination-forwarding dependency from required flow,
  - discover default VPC + subnets via new `src/command/aws/network.ts` (`DescribeVpcs`, `DescribeSubnets`),
  - generate webhook secret each deploy (`crypto.randomUUID()` + entropy suffix),
  - ensure/create artifact S3 bucket, upload embedded lambda zip (`@aws-sdk/client-s3`),
  - pass CFN params: `LambdaCodeS3Bucket`, `LambdaCodeS3Key`, `VpcId`, `SubnetIds`, `WebhookSecret`.
- Keep stack create/update/noop handling as-is.

4. CloudFormation template changes
- Keep APIGW -> SQS pattern, but mapping template must preserve verify inputs:
  - include base64 body and required webhook headers in message body JSON.
- Replace Lambda `Code.ZipFile` with `Code.S3Bucket/S3Key` params.
- Remove old `DESTINATION_URL` env usage.
- Add ECS resources:
  - `WebhookEcsCluster`
  - `WebhookTaskLogGroup`
  - `WebhookTaskExecutionRole`
  - `WebhookTaskRole`
  - `WebhookTaskSecurityGroup` (VpcId param)
  - `WebhookTaskDefinition` (Fargate, fixed image placeholder)
- Lambda role policy add:
  - `ecs:RunTask` on task definition
  - `iam:PassRole` for ECS task roles
  - existing SQS consume + logs.
- Lambda env vars include ECS cluster/taskdef/subnets/sg + assign public IP enabled.
- Add outputs: ECS cluster arn/name + task definition arn.

5. GitHub webhook upsert alignment
- In `src/command/aws/github.ts` ensure upsert always sends generated secret.
- Keep repo autodetect behavior.
- Deploy should log webhook target + secret rotation note.

6. Dependencies
- Add runtime deps:
  - `@octokit/webhooks`
  - `@octokit/webhooks-types`
  - `@aws-sdk/client-ecs`
  - `@aws-sdk/client-ec2`
  - `@aws-sdk/client-s3`
  - `@aws-sdk/client-sts` (bucket naming/account id)
  - zip helper lib if needed for artifact generation.

## Verification
1. Local
- `bun install`
- `bun run build:lambda-artifact`
- `bun test`
- `bun run cli -- aws deploy --help`
- `bun run cli -- aws deploy --dry-run-template` (confirm ECS + lambda S3 params present)
- `bun run build`

2. Sandbox deploy
- `assume sandbox --exec -- bun cli aws deploy`
- Confirm outputs include `ApiInvokeUrl`, `QueueUrl`, `LambdaName`, ECS outputs.

3. End-to-end webhook -> ECS
- Trigger webhook ping (`gh api --method POST repos/<owner>/<repo>/hooks/<id>/pings`).
- Verify SQS sent metric increments.
- Verify Lambda logs show signature verified.
- Verify ECS task launched (`aws ecs list-tasks`/`describe-tasks`) and container logs exist.

4. Negative verify
- Send invalid-signature test event.
- Confirm Lambda rejects and no ECS task starts.

## Unresolved questions
- none
