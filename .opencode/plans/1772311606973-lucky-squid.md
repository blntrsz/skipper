# Plan: workers sync via aws deploy

## Goal
- make `skipper aws deploy` single deploy path from current repo
- remove `skipper workers sync`
- ensure deployed Lambda + webhook subscriptions come from `.skipper/worker/*.ts`

## Changes
1) CLI wiring
- update `src/app/register-commands.ts`: remove workers namespace import + registration call
- delete `src/command/workers/index.ts`
- delete `src/command/workers/sync.ts`
- delete `src/command/workers/sync.test.ts`

2) Deploy flow owns worker sync
- in `src/command/aws/deploy.ts`:
  - add `--dir <path>` and `--strict-workers`
  - load workers via `loadWorkers(rootDir)` during context build
  - encode via `encodeWorkerManifest({ workers })`
  - store encoded params + worker metadata in deploy context
  - `createTemplateParameters` spreads encoded worker `parameterValues` instead of `createDefaultWorkerParameterValues()`
  - dry-run output includes `workerCount`, `workerIds`, `serializedJsonBytes`, and resolved webhook events

3) Webhook subscription from workers config
- add `src/worker/github-events.ts` helper:
  - extract unique GitHub events from enabled worker triggers
  - ignore non-github providers
  - dedupe + stable sort
- in `src/command/aws/deploy.ts`, resolve webhook events policy:
  - explicit `--github-events`: merge with derived worker events
  - no explicit: use derived worker events
  - if both empty: fallback `[*]`
- keep `--skip-github-webhook` behavior unchanged

4) CloudFormation + Lambda scope
- keep existing infra resources (already present):
  - `src/command/aws/template.ts` already defines Lambda, SQS->Lambda mapping, worker params/env
  - `src/command/aws/lambda/handler.ts` already routes by worker trigger event/action
- no new CFN resource required; key fix is passing real worker params in deploy

5) Tests
- update `src/command/aws/deploy.test.ts`:
  - worker params come from encoded manifest path
  - github event merge/fallback behavior
- add `src/worker/github-events.test.ts`
- remove obsolete `src/command/workers/sync.test.ts`
- keep `src/command/aws/template.test.ts` coverage for worker params + lambda env wiring

## Verification
- `bun test src/worker/github-events.test.ts`
- `bun test src/command/aws/deploy.test.ts`
- `bun test src/command/aws/template.test.ts`
- dry-run: `bun run cli -- aws deploy <service> <env> --dir . --dry-run-template --skip-github-webhook`
- deploy check: `bun run cli -- aws deploy <service> <env> --dir .`
- post-deploy checks:
  - stack updates without separate sync step
  - webhook event set matches worker trigger events
  - lambda logs show matched workers for subscribed events

## Migration
- breaking CLI change: remove `workers sync`
- new flow: run `aws deploy` whenever worker config changes
- update scripts/CI to remove sync step

## Unresolved questions
- none
