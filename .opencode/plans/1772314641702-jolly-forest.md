# Plan: repo-scoped aws deploy template

## Goal
- make `aws deploy` deploy a separate CloudFormation template (not bootstrap alias)
- make deploy stack/template repo-scoped
- enforce EventBridge subscription to only target repo events

## Recommended approach
1) Split bootstrap vs deploy command flow
- update `src/command/aws/deploy.ts` from alias -> real command handler
- keep `src/command/aws/bootstrap.ts` for shared ingress stack (`${service}-${env}-bootstrap`)
- in deploy context, resolve repo via existing `resolveGithubRepo(...)`; require repo unless explicitly skipped paths
- add deploy stack default name prefixed by repo slug, e.g. `${repoSlug}-${service}-${env}-deploy` (still allow `--stack-name` override)
- add `--bootstrap-stack-name` option (default `${service}-${env}-bootstrap`) so deploy can resolve shared outputs (event bus/source/detail-type/API URL)

2) Add separate deploy template module
- add `src/command/aws/deploy-template.ts` (new) with `buildDeployTemplate()`
- deploy template params include at least: `ServiceName`, `Environment`, `RepositoryFullName`, `RepositoryPrefix`, `EventBusName`, `EventSource`, `EventDetailType`
- deploy template creates repo-scoped EventBridge rule on shared bus with pattern filter:
  - `source == EventSource`
  - `detail-type == EventDetailType`
  - `detail.repository.full_name == RepositoryFullName`
- name deploy-owned resources with repo prefix (`RepositoryPrefix`) where names are explicit

3) Ensure ingress event detail supports repo filtering
- update `src/command/aws/template.ts` API Gateway -> EventBridge mapping so event `Detail` includes parsed `repository.full_name`
- keep existing `rawBodyB64` + header fields; add repo field only for EventBridge rule filtering
- update `src/command/aws/template.test.ts` assertions for new detail field

4) Add repo-prefix normalization helper
- add/export helper in `src/command/aws/github.ts` or `src/command/aws/defaults.ts` to derive deterministic repo slug from `owner/repo`:
  - lowercase
  - non `[a-z0-9-]` -> `-`
  - collapse/trim `-`
- use helper in deploy stack naming + template parameters
- add tests in `src/command/aws/github.test.ts` (or new deploy test) for slug edge cases

5) Deploy command behavior and dry-run
- `aws deploy` should:
  - load worker events (existing `loadWorkers` + `collectGithubEventsFromWorkers`) for future event filtering/reporting
  - resolve shared bus config from CLI overrides or bootstrap outputs
  - build deploy template via `buildDeployTemplate()`
  - call `deployStack(...)`
- dry-run output should include: resolved repo, repo slug, repo-prefixed stack name, EventBridge rule pattern, template JSON

6) Tests
- add `src/command/aws/deploy.test.ts` (new):
  - repo inference + slug normalization
  - default stack naming prefixed by repo
  - deploy dry-run payload includes repo-scoped rule pattern
- update `src/command/aws/bootstrap.test.ts` only if shared-output lookup helpers are added there
- keep `src/command/aws/cloudformation.test.ts` unchanged unless adding stack-name validator

## Critical files to modify
- `src/command/aws/deploy.ts`
- `src/command/aws/deploy-template.ts` (new)
- `src/command/aws/template.ts`
- `src/command/aws/template.test.ts`
- `src/command/aws/github.ts` or `src/command/aws/defaults.ts`
- `src/command/aws/github.test.ts` and/or `src/command/aws/deploy.test.ts` (new)

## Verification
1. Unit tests
- `bun test src/command/aws/template.test.ts`
- `bun test src/command/aws/deploy.test.ts`
- `bun test src/command/aws/github.test.ts`

2. CLI dry-run checks
- `bun run cli -- aws bootstrap <service> <env> --dry-run-template`
  - verify EventBridge detail includes `repository.full_name`
- `bun run cli -- aws deploy <service> <env> --github-repo <owner/repo> --dry-run-template`
  - verify stack name starts with repo slug prefix
  - verify EventBridge rule pattern filters only `<owner/repo>`

3. Full regression
- `bun test`

## Unresolved questions
- none
